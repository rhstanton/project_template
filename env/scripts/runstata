#!/usr/bin/env bash
# ==============================================================================
# Stata Environment Runner
# ==============================================================================
#
# This script runs Stata do-files with proper environment checking.
#
# Usage:
#   env/scripts/runstata script.do [args...]
#
# ==============================================================================

set -eu  # Removed -o pipefail to allow grep filtering

# Unset CDPATH to prevent cd from printing directories
unset CDPATH

DO_FILE="$1"

if [ -z "$DO_FILE" ]; then
    echo "Usage: runstata <file.do>"
    exit 1
fi

# Get to project root (two levels up from env/scripts/)
cd "$(dirname "$0")/../.."
PROJECT_ROOT="$(pwd)"

# Extract base name for log file
BASE="${DO_FILE%.do}"
LOG_FILE="output/logs/${BASE##*/}.log"

# Create temporary setup file
TEMP_DO=$(mktemp /tmp/stata_XXXXXX.do)
trap "rm -f $TEMP_DO" EXIT

# Write the setup commands
echo "quietly adopath ++ \"${PROJECT_ROOT}/.stata/ado/plus\"" > "$TEMP_DO"
echo "quietly adopath ++ \"${PROJECT_ROOT}/env/scripts\"" >> "$TEMP_DO"
echo "execute ${DO_FILE}" >> "$TEMP_DO"

# Run Stata, capturing output to detect errors
# - timeout 10: Kill after 10 seconds to prevent infinite hangs
# - -q flag: Quiet mode (suppress Stata banner)
# - execute.ado displays errors with "Error in do-file (return code: ###)"
# - TERM=dumb prevents Stata from waiting for terminal input
# - </dev/null ensures Stata can't wait for stdin
# 
# Note: Stata batch mode always returns exit code 0 unless it crashes.
# We must parse output to detect script errors.
echo ""
set +e  # Disable exit on error for stata call
TEMP_OUT=$(mktemp /tmp/stata_out_XXXXXX.txt)
trap "rm -f $TEMP_DO $TEMP_OUT" EXIT

TERM=dumb timeout 10 stata-mp -q do "$TEMP_DO" </dev/null 2>&1 | tee "$TEMP_OUT"
STATA_EXIT=$?

# Check if output contains error pattern from execute.ado
if grep -q "Error in do-file (return code:" "$TEMP_OUT"; then
    # Extract error code
    ERROR_CODE=$(grep "Error in do-file (return code:" "$TEMP_OUT" | sed 's/.*return code: \([0-9]\+\).*/\1/' | tail -1)
    echo "Stata script failed with return code $ERROR_CODE" >&2
    exit 1
fi

set -e  # Re-enable
echo ""
exit $STATA_EXIT

